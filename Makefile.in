# Tools
CC = @CC@
AR = @AR@
RANLIB = @RANLIB@
CFLAGS = @CFLAGS@
LDFLAGS = @LDFLAGS@
CPPFLAGS = @CPPFLAGS@
SHOBJFLAGS = @SHOBJFLAGS@
SHOBJLDFLAGS = @SHOBJLDFLAGS@

# Paths
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@

# Target objects
LIBOBJS = libdact.o
SHLIBOBJS = libdact_shr.o
SRCOBJS = $(LIBOBJS:.o=.c)

# Default build target
all: libdact.@SHOBJEXT@ libdact.@AREXT@

# Specific build rules
## Build shared object
libdact.@SHOBJEXT@: $(SHLIBOBJS) libdact.vers
	$(CC) $(CFLAGS) $(SHOBJLDFLAGS) -o libdact.@SHOBJEXT@ $(LDFLAGS) $(SHLIBOBJS)
	@WEAKENSYMS@ libdact.@SHOBJEXT@
	@REMOVESYMS@ libdact.@SHOBJEXT@

## Build static object
libdact.@AREXT@: libdact_combined_shr.o
	@WEAKENSYMS@ libdact_combined_shr.o
	@REMOVESYMS@ libdact_combined_shr.o
	$(AR) cr libdact.@AREXT@ libdact_combined_shr.o
	$(RANLIB) libdact.@AREXT@

## Build amalgamation of source to build a single object file
libdact_combined.c: $(SRCOBJS)
	cat $(SRCOBJS) > libdact_combined.c

## Build GNU LD version script to strip symbols
libdact.vers: libdact.syms.in
	echo '/* This file is automatically generated. */' > libdact.vers
	echo '{' >> libdact.vers
	echo '  global:' >> libdact.vers
	for symbol in `cat libdact.syms.in | sed 's/^@''SYMPREFIX@//'`; do \
		echo "          $${symbol};"; \
	done >> libdact.vers
	echo '  local:' >> libdact.vers
	echo '          *;' >> libdact.vers
	echo '};' >> libdact.vers

## Build structures of registered components
### Compression algorithms
algorithm-defs.h: registration/compression
	sed 's@#.*@@' registration/compression | grep -v '^ *$$' | awk '{ print "#define DACT_COMP_ALGO_" toupper($$2) "_ID " $$1 }' > algorithm-defs.h

builtin-algorithms.c: builtin-algorithms.c.in registration/compression

### Encryption algorithms
ciphers.h builtin-ciphers.c: ciphers.h.in builtin-ciphers.c.in registration/encryption
	false

# Generic build rules
%.o: %.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -o "$@" -c "$^"

%_shr.o: %.c
	$(CC) $(CPPFLAGS) $(CFLAGS) $(SHOBJFLAGS) -o "$@" -c "$^"

# Dependencies
algorithms.h: algorithm-defs.h
libdact_combined.o: libdact_combined.c
libdact_combined_shr.o: libdact_combined.c
libdact.o: libdact.c
libdact_shr.o: libdact.c

# Cleanup targets
clean:
	rm -f $(LIBOBJS) $(SHLIBOBJS)
	rm -f libdact.@SHOBJEXT@ libdact.@AREXT@ dact@EXE@
	rm -f libdact_combined_shr.o libdact_combined.c

distclean: clean
	rm -f config.h Makefile libdact.syms
	rm -f config.status config.log

mrproper: distclean
	rm -f libdact.vers
	rm -f algorithm-defs.h builtin-algorithms.c
	./build/autogen.sh distclean

# Make directive targets
.PHONY: all clean distclean mrproper
